<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Learning Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1cb0f6',
                        success: '#58cc02',
                        warning: '#ff9600',
                        danger: '#ff4b4b',
                        purple: '#ce82ff',
                        gold: '#ffc800'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">

    <!-- Navigation -->
    <nav id="navbar" class="bg-white shadow-md fixed top-0 w-full z-50 hidden">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-primary">üåç LernPlattform</h1>
                    <div class="ml-6 flex space-x-8">
                        <a href="#" onclick="showPage('dashboard')" class="nav-link">Dashboard</a>
                        <a href="#" onclick="showPage('profile')" class="nav-link">Profil</a>
                        <a href="#" onclick="showPage('learning')" class="nav-link student-only hidden">Lernen</a>
                        <a href="#" onclick="showPage('teachers')" class="nav-link student-only hidden">Lehrer finden</a>
                        <a href="#" onclick="showPage('admin')" class="nav-link admin-only hidden">Admin</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-greeting" class="text-sm text-gray-700"></span>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded">Abmelden</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen">

        <!-- Welcome Page -->
        <div id="welcome-page" class="page-section">
            <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary to-purple">
                <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800 mb-2">üåç</h1>
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">LernPlattform</h2>
                        <p class="text-gray-600">Sprachen lernen wie mit Duolingo</p>
                    </div>
                    <div class="space-y-4">
                        <button onclick="showPage('login')" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg">
                            Anmelden
                        </button>
                        <button onclick="showPage('register')" class="w-full bg-success text-white font-bold py-3 px-4 rounded-lg">
                            Registrieren
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page-section hidden">
            <div class="min-h-screen flex items-center justify-center py-12 px-4">
                <div class="max-w-md w-full space-y-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-900">Anmelden</h2>
                    </div>
                    <form onsubmit="handleLogin(event)" class="space-y-6">
                        <div id="login-error" class="hidden bg-red-100 text-red-700 px-4 py-3 rounded"></div>
                        <div>
                            <input name="username" type="text" required placeholder="Benutzername" 
                                   class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <div>
                            <input name="password" type="password" required placeholder="Passwort"
                                   class="w-full px-3 py-2 border rounded-md">
                        </div>
                        <button type="submit" class="w-full bg-primary text-white py-2 rounded-md">
                            Anmelden
                        </button>
                    </form>
                    <div class="text-center">
                        <a href="#" onclick="showPage('register')" class="text-primary">Noch kein Account? Registrieren</a><br>
                        <a href="#" onclick="showPage('welcome')" class="text-gray-500">‚Üê Zur√ºck</a>
                    </div>
                    <div class="text-center mt-4 p-4 bg-blue-50 rounded">
                        <p class="text-sm font-semibold">Demo-Accounts:</p>
                        <p class="text-xs">Student: demo_student / Demo123!</p>
                        <p class="text-xs">Teacher: demo_teacher / Demo123!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="page-section hidden">
            <div class="min-h-screen flex items-center justify-center py-12 px-4">
                <div class="max-w-md w-full space-y-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-900">Registrieren</h2>
                    </div>
                    <form onsubmit="handleRegister(event)" class="space-y-4">
                        <div id="register-message" class="hidden px-4 py-3 rounded"></div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Ich bin:</label>
                            <div class="flex space-x-4">
                                <label><input type="radio" name="userType" value="student" checked> Sch√ºler</label>
                                <label><input type="radio" name="userType" value="teacher"> Lehrer</label>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <input name="name" type="text" required placeholder="Vorname" class="px-3 py-2 border rounded-md">
                            <input name="surname" type="text" required placeholder="Nachname" class="px-3 py-2 border rounded-md">
                        </div>
                        
                        <input name="email" type="email" required placeholder="E-Mail" class="w-full px-3 py-2 border rounded-md">
                        <input name="username" type="text" required placeholder="Benutzername" class="w-full px-3 py-2 border rounded-md">
                        <input name="password" type="password" required placeholder="Passwort" class="w-full px-3 py-2 border rounded-md">
                        <input name="confirmPassword" type="password" required placeholder="Passwort best√§tigen" class="w-full px-3 py-2 border rounded-md">
                        
                        <label class="flex items-center">
                            <input name="acceptTerms" type="checkbox" required class="mr-2">
                            Ich akzeptiere die Nutzungsbedingungen
                        </label>
                        
                        <button type="submit" class="w-full bg-success text-white py-2 rounded-md">
                            Account erstellen
                        </button>
                    </form>
                    <div class="text-center">
                        <a href="#" onclick="showPage('login')" class="text-primary">Bereits ein Account? Anmelden</a><br>
                        <a href="#" onclick="showPage('welcome')" class="text-gray-500">‚Üê Zur√ºck</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page-section hidden">
            <div class="pt-16 max-w-7xl mx-auto py-6 px-4">
                <div class="mb-8">
                    <h1 id="dashboard-title" class="text-3xl font-bold text-gray-900">Dashboard</h1>
                    <p id="dashboard-subtitle" class="text-gray-600">Willkommen zur√ºck!</p>
                </div>
                
                <!-- Student Dashboard -->
                <div id="student-dashboard" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-2">üìö Lernfortschritt</h3>
                            <div class="text-2xl font-bold text-primary" id="student-xp">0 XP</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-2">üî• Streak</h3>
                            <div class="text-2xl font-bold text-warning" id="student-streak">0 Tage</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-2">‚≠ê Aufgaben</h3>
                            <div class="text-2xl font-bold text-success" id="student-tasks">0</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button onclick="showPage('learning')" class="bg-primary text-white px-6 py-3 rounded-lg">
                            Weiterlernen
                        </button>
                        <button onclick="showPage('teachers')" class="bg-success text-white px-6 py-3 rounded-lg">
                            Lehrer finden
                        </button>
                        <button onclick="showPage('achievements')" class="bg-purple text-white px-6 py-3 rounded-lg">
                            Erfolge
                        </button>
                        <button onclick="showPage('profile')" class="bg-gray-600 text-white px-6 py-3 rounded-lg">
                            Profil
                        </button>
                    </div>
                </div>
                
                <!-- Teacher Dashboard -->
                <div id="teacher-dashboard" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-2">üë• Sch√ºler</h3>
                            <div class="text-2xl font-bold text-primary" id="teacher-students">0</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-2">üìñ Kurse</h3>
                            <div class="text-2xl font-bold text-success" id="teacher-courses">2</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium mb-2">üîë Teacher-Code</h3>
                            <div class="text-xl font-bold text-purple" id="teacher-code">TCHDMO</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button onclick="showPage('students')" class="bg-primary text-white px-6 py-3 rounded-lg">
                            Sch√ºler verwalten
                        </button>
                        <button onclick="showPage('admin'); setTimeout(() => adminSystem.showCourseManagement(), 100);" 
                                class="bg-success text-white px-6 py-3 rounded-lg">
                            Kurse verwalten
                        </button>
                        <button onclick="showPage('analytics')" class="bg-warning text-white px-6 py-3 rounded-lg">
                            Statistiken
                        </button>
                        <button onclick="showPage('profile')" class="bg-gray-600 text-white px-6 py-3 rounded-lg">
                            Profil
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page-section hidden">
            <div class="pt-16 max-w-4xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Profil</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <div id="profile-content">
                        <p class="text-gray-600">Lade Profil-Daten...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Page -->
        <div id="learning-page" class="page-section hidden">
            <div class="pt-16 max-w-4xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Lernen</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <div id="learning-content">
                        <p class="text-gray-600">Lade Lern-Inhalte...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teachers Page -->
        <div id="teachers-page" class="page-section hidden">
            <div class="pt-16 max-w-4xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Lehrer finden</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <div class="space-y-6">
                        <div>
                            <h2 class="text-xl font-semibold mb-4">Mit Teacher-Code verbinden</h2>
                            <div class="flex space-x-4">
                                <input type="text" id="teacher-code-input" placeholder="Teacher-Code (z.B. TCHDMO)" 
                                       class="flex-1 border rounded-md px-3 py-2">
                                <button onclick="connectToTeacher()" class="bg-primary text-white px-6 py-2 rounded-md">
                                    Verbinden
                                </button>
                            </div>
                        </div>
                        <div id="followed-teachers">
                            <!-- Gefolgete Lehrer werden hier angezeigt -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other Pages (Placeholder) -->
        <div id="achievements-page" class="page-section hidden">
            <div class="pt-16 max-w-4xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Erfolge</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Achievement-System kommt bald...</p>
                </div>
            </div>
        </div>

        <div id="courses-page" class="page-section hidden">
            <div class="pt-16 max-w-4xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Kurse verwalten</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Kurs-Management kommt bald...</p>
                </div>
            </div>
        </div>

        <div id="students-page" class="page-section hidden">
            <div class="pt-16 max-w-4xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Sch√ºler verwalten</h1>
                <div class="bg-white shadow rounded-lg p-6">
                    <p class="text-gray-600">Sch√ºler-Management kommt bald...</p>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="page-section hidden">
            <div class="pt-16 max-w-7xl mx-auto py-6 px-4">
                <div id="admin-content">
                    <p class="text-gray-600">Lade Admin-Interface...</p>
                </div>
            </div>
        </div>

    </main>

    <!-- JavaScript -->
    <script src="js/utils.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // ==========================================
        // SIMPLE NAVIGATION SYSTEM
        // ==========================================
        
        function showPage(pageId) {
            console.log('Navigate to (mit Security):', pageId);

            // Security-Check
            if (!securePageAccess(pageId)) {
                return; // Access denied
            }

            // Learning-Engine cleanup - NUR wenn wir NICHT im Learning sind
            if (window.learningEngine && window.learningEngine.initialized && pageId !== 'learning') {
                console.log('Exiting Learning Mode...');
                window.learningEngine.exitLearningMode();
            }

            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.add('hidden');
            });
            
            const learningPage = document.getElementById('learning-page');
            if (learningPage && pageId !== 'learning') {
                learningPage.classList.add('hidden');
            }

            // Show target page
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.remove('hidden');

                const navbar = document.getElementById('navbar');
                const publicPages = ['welcome', 'login', 'register'];

                if (publicPages.includes(pageId)) {
                    navbar.style.display = 'none';  // Erzwingt hiding
                } else {
                    navbar.style.display = 'block'; // Zeigt navbar

                    if (!window.currentUser) {
                        showPage('login');
                        showMessage('Bitte melde dich an', 'warning');
                        return;
                    }

                    loadPageContent(pageId);
                }
            }
        }

        function loadPageContent(pageId) {
            switch(pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'learning':
                    if (window.loadAdvancedLearningInterface) {
                        loadAdvancedLearningInterface();
                    } else {
                        loadLearning();
                    }
                    break;
                case 'teachers':
                    loadTeachers();
                    break;
                case 'students':
                    if (window.teacherStudentManager && window.currentUser?.userType === 'teacher') {
                        teacherStudentManager.initialize();
                        teacherStudentManager.loadEnhancedStudentManagement();
                    }
                    break;
                case 'admin':
                    if (window.loadAdminInterface && window.currentUser?.userType === 'admin') {
                        loadAdminInterface();
                    }
                    break;
            }
        }

        function loadDashboard() {
            if (!window.currentUser) return;
            
            // Update greeting
            document.getElementById('user-greeting').textContent = `Hallo, ${window.currentUser.name}!`;
            
            if (window.currentUser.userType === 'student') {
                document.getElementById('student-dashboard').classList.remove('hidden');
                document.getElementById('teacher-dashboard').classList.add('hidden');
                
                // Load student data
                const progress = progressManager.getUserProgress(window.currentUser.id);
                document.getElementById('student-xp').textContent = progress.totalXP + ' XP';
                document.getElementById('student-streak').textContent = progress.currentStreak + ' Tage';
                document.getElementById('student-tasks').textContent = progress.totalTasksCompleted;
                
                document.querySelectorAll('.student-only').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.teacher-only').forEach(el => el.classList.add('hidden'));
            } else if (window.currentUser.userType === 'teacher') {
                document.getElementById('teacher-dashboard').classList.remove('hidden');
                document.getElementById('student-dashboard').classList.add('hidden');
                
                // Load teacher data
                const students = relationshipManager.getStudentsOfTeacher(window.currentUser.id);
                document.getElementById('teacher-students').textContent = students.length;
                document.getElementById('teacher-code').textContent = window.currentUser.teacherCode;
                
                document.querySelectorAll('.teacher-only').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.student-only').forEach(el => el.classList.add('hidden'));
            } else if (window.currentUser.userType === 'admin') {
                // Admin sieht Teacher-Dashboard + Admin-Navigation
                document.getElementById('teacher-dashboard').classList.remove('hidden');
                document.getElementById('student-dashboard').classList.add('hidden');
                
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.teacher-only').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.student-only').forEach(el => el.classList.add('hidden'));
            }
        }

        function loadProfile() {
            if (!window.currentUser) return;
            
            document.getElementById('profile-content').innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center text-white text-2xl font-bold">
                            ${window.currentUser.name.charAt(0)}${window.currentUser.surname.charAt(0)}
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold">${window.currentUser.name} ${window.currentUser.surname}</h2>
                            <p class="text-gray-600">@${window.currentUser.username}</p>
                            <p class="text-sm text-gray-500">${window.currentUser.userType === 'student' ? 'Sch√ºler' : 'Lehrer'}</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold mb-2">E-Mail:</h3>
                        <p>${window.currentUser.email}</p>
                    </div>
                    ${window.currentUser.teacherCode ? `
                    <div>
                        <h3 class="font-semibold mb-2">Teacher-Code:</h3>
                        <p class="font-mono text-lg">${window.currentUser.teacherCode}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function loadLearning() {
            if (!window.currentUser) return;
            
             const container = document.getElementById('learning-content');
            if (!container) return;

            const availableCourses = getAvailableCoursesForUser(window.currentUser.id, window.currentUser.userType);
            const userProgress = progressManager.getUserProgress(window.currentUser.id);
            
            let html = '<h2 class="text-xl font-semibold mb-4">Verf√ºgbare Kurse</h2>';
            
            if (availableCourses.length === 0) {
                html += '<p class="text-gray-600">Noch keine Kurse verf√ºgbar. Finde einen Lehrer!</p>';
            } else {
                html += '<div class="space-y-4">';
                availableCourses.forEach(course => {
                    const progress = progressManager.calculateCourseProgress(window.currentUser.id, course.id, course);
                    html += `
                        <div class="border rounded-lg p-4">
                            <h3 class="font-semibold">${course.title}</h3>
                            <p class="text-gray-600">${course.description}</p>
                            <div class="mt-2 flex items-center justify-between">
                                <div class="text-sm text-gray-500">${progress.percentage}% abgeschlossen</div>
                                <button onclick="startCourse('${course.id}')" class="bg-primary text-white px-4 py-2 rounded">
                                    ${progress.percentage > 0 ? 'Weiterlernen' : 'Starten'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('learning-content').innerHTML = html;
        }

        function loadTeachers() {
            if (!window.currentUser) return;
            
            const followedTeachers = relationshipManager.getTeachersOfStudent(window.currentUser.id);
            
            let html = '';
            if (followedTeachers.length > 0) {
                html += '<h3 class="text-lg font-semibold mb-4">Deine Lehrer</h3>';
                html += '<div class="space-y-3">';
                followedTeachers.forEach(rel => {
                    html += `
                        <div class="border rounded-lg p-4">
                            <h4 class="font-semibold">${rel.teacher.name} ${rel.teacher.surname}</h4>
                            <p class="text-sm text-gray-600">Code: ${rel.teacher.teacherCode}</p>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('followed-teachers').innerHTML = html;
        }

        function startCourse(courseId) {
            showMessage(`Kurs ${courseId} wird gestartet...`, 'info');
            // Sp√§ter: Learning Engine starten
        }

        function connectToTeacher() {
            const code = document.getElementById('teacher-code-input').value.trim();
            if (!code) {
                showMessage('Bitte Teacher-Code eingeben', 'warning');
                return;
            }
            
            const result = relationshipManager.connectStudentToTeacher(window.currentUser.id, code);
            if (result.success) {
                showMessage(result.message, 'success');
                loadTeachers();
                document.getElementById('teacher-code-input').value = '';
            } else {
                showMessage(result.message, 'error');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const result = attemptLogin({
                username: formData.get('username'),
                password: formData.get('password')
            });
            
            if (result.success) {
                window.currentUser = result.user;
                showPage('dashboard');
            } else {
                document.getElementById('login-error').textContent = result.message;
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const result = attemptRegister({
                name: formData.get('name'),
                surname: formData.get('surname'),
                email: formData.get('email'),
                username: formData.get('username'),
                password: formData.get('password'),
                confirmPassword: formData.get('confirmPassword'),
                userType: formData.get('userType'),
                acceptTerms: formData.get('acceptTerms')
            });
            
            const messageDiv = document.getElementById('register-message');
            if (result.success) {
                messageDiv.className = 'bg-green-100 text-green-700 px-4 py-3 rounded';
                messageDiv.textContent = 'Account erstellt! Weiterleitung zum Login...';
                messageDiv.classList.remove('hidden');
                setTimeout(() => showPage('login'), 2000);
            } else {
                messageDiv.className = 'bg-red-100 text-red-700 px-4 py-3 rounded';
                messageDiv.textContent = result.message;
                messageDiv.classList.remove('hidden');
            }
        }

        function logout() {
            console.log('üö™ Logout wird durchgef√ºhrt...');

            // 1. Proper session cleanup mit auth.js Funktion
            if (window.clearUserSession) {
                clearUserSession(); // Verwendet korrekte Storage-Keys
            }

            // 2. Manual cleanup als Fallback
            window.currentUser = null;
            localStorage.removeItem('currentUser');     // Key
            localStorage.removeItem('authToken');       // Token auch l√∂schen
            localStorage.removeItem('activeLearningSession'); // Learning-Session l√∂schen

            // 3. UI State komplett zur√ºcksetzen
            resetUIState();

            // 4. Navigation
            showPage('welcome');

            // 5. Best√§tigung
            showMessage('Erfolgreich abgemeldet', 'success');

            console.log('‚úÖ Logout komplett abgeschlossen');
        }

        function showMessage(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            if (window.showNotification) {
                showNotification(message, type);
            }
        }

        // Initialize app
        function initApp() {
            console.log('üöÄ App wird initialisiert...');

            // 1. Session-Validation statt blind vertrauen
            const savedUser = localStorage.getItem('currentUser');
            const authToken = localStorage.getItem('authToken');

            if (savedUser && authToken) {
                try {
                    const user = JSON.parse(savedUser);

                    // Token validieren
                    if (window.TokenManager && window.TokenManager.validateToken) {
                        const tokenPayload = TokenManager.validateToken(authToken);
                        if (!tokenPayload) {
                            console.log('üîí Token ung√ºltig - Session gel√∂scht');
                            clearUserSession();
                            showPage('welcome');
                            return;
                        }
                    }

                    window.currentUser = user;
                    showPage('dashboard');

                    // Session-Recovery pr√ºfen (nach erfolgreicher Auth)
                    setTimeout(() => checkForSavedSession(), 500);

                } catch (e) {
                    console.log('‚ùå Session-Daten korrupt - bereinigt');
                    clearUserSession();
                    showPage('welcome');
                }
            } else {
                showPage('welcome');
            }

            console.log('‚úÖ App initialisiert');
        }

        // Start app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

                // Session-Recovery f√ºr TC020-Fix
        function checkForSavedSession() {
            if (!window.currentUser) return;
            
            const savedSession = learningEngine.loadSavedSession();
            if (!savedSession) return;

            showSessionRecoveryModal(savedSession);
        }

        function showSessionRecoveryModal(sessionData) {
            const modal = document.createElement('div');
            modal.id = 'session-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50';
            
            const progress = Math.round((sessionData.taskIndex / sessionData.sessionTotal) * 100);
            const timeAgo = Math.round((Date.now() - sessionData.timestamp) / (1000 * 60)); // Minuten
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
                    <h3 class="text-xl font-bold mb-4">Lektion fortsetzen?</h3>
                    <p class="text-gray-600 mb-4">Du hattest eine Lektion in Bearbeitung</p>
                    <div class="bg-gray-50 p-4 rounded mb-4 text-left">
                        <div class="font-medium">Fortschritt: ${progress}%</div>
                        <div class="text-sm text-gray-600">Aufgabe ${sessionData.taskIndex + 1} von ${sessionData.sessionTotal}</div>
                        <div class="text-sm text-gray-500">Vor ${timeAgo} Minuten</div>
                    </div>
                    <div class="space-y-3">
                        <button onclick="continueSession()" class="w-full bg-primary text-white py-2 rounded">
                            Fortsetzen
                        </button>
                        <button onclick="discardSession()" class="w-full bg-gray-300 text-gray-700 py-2 rounded">
                            Neu starten
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function continueSession() {
            const sessionData = learningEngine.loadSavedSession();
            document.getElementById('session-modal')?.remove();

            if (sessionData) {
                showPage('learning');
                setTimeout(() => {
                    // Learning Engine erst initialisieren
                    if (!learningEngine.initialized) {
                        const success = learningEngine.initialize('learning-page');
                        if (!success) {
                            console.error('Learning Engine Initialisierung fehlgeschlagen');
                            return;
                        }
                    }

                    // Dann Session wiederherstellen
                    learningEngine.restoreSession(sessionData);
                }, 100);
            }
        }

        function discardSession() {
            learningEngine.clearLearningSession();
            document.getElementById('session-modal')?.remove();
        }

        /**
         * UI-State komplett zur√ºcksetzen
         */
        function resetUIState() {
            // Navigation-Links verstecken
            document.querySelectorAll('.student-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.teacher-only').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                    
            // Navbar explizit verstecken
            const navbar = document.getElementById('navbar');
            if (navbar) {
                navbar.style.display = 'none';
            }

            // User-Greeting l√∂schen
            const greeting = document.getElementById('user-greeting');
            if (greeting) greeting.textContent = '';

            // Dashboard-Content l√∂schen
            const studentDashboard = document.getElementById('student-dashboard');
            if (studentDashboard) studentDashboard.classList.add('hidden');

            const teacherDashboard = document.getElementById('teacher-dashboard');
            if (teacherDashboard) teacherDashboard.classList.add('hidden');

            // Learning-Engine state l√∂schen (falls aktiv)
            if (window.learningEngine && window.learningEngine.initialized) {
                try {
                    learningEngine.clearLearningSession();
                } catch (error) {
                    console.log('Learning-Engine Cleanup Fehler (ignoriert):', error);
                }
            }

            console.log('üßπ UI-State zur√ºckgesetzt');
        }

        // Security-Check f√ºr Page-Access
        function securePageAccess(pageId) {
            const protectedPages = ['dashboard', 'profile', 'learning', 'students', 'admin'];
            
            if (protectedPages.includes(pageId)) {
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('Unauthorized page access blocked:', pageId);
                    showPage('login');
                    showMessage('Bitte melde dich an', 'warning');
                    return false;
                }
                
                if (pageId === 'students' && currentUser.userType !== 'teacher') {
                    showNotification('Nur f√ºr Lehrer verf√ºgbar', 'error');
                    showPage('dashboard');
                    return false;
                }
                
                if (pageId === 'admin' && currentUser.userType !== 'admin') {
                    showNotification('Nur f√ºr Admins verf√ºgbar', 'error');
                    showPage('dashboard');
                    return false;
                }
            }
            
            return true;
        }
    </script>

    <script src="js/admin-system.js"></script>
    <script src="js/teacher-student-system.js"></script>
    <script src="js/course-permission-system.js"></script>
    <script src="js/course-engine.js"></script>

</body>
</html>